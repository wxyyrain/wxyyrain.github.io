<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="聚合语法 #  { &#34;size&#34;: 0, &#34;aggs&#34;: { // 与query同级的关键词  &#34;&lt;aggs_name&gt;&#34;: { // 自定义的聚合名字  &#34;&lt;aggs_type&gt;&#34;: { // 聚合的定义：不同的Type &#43; Body  &lt;aggs_body&gt; }, &#34;aggs&#34;: {} // 子聚合查询  }, &#34;&lt;aggs_name_2&gt;&#34; : {} // 可以包含多个同级的聚合查询  } } Metric #   一些系列的统计方法，会基于数据集计算结果，除了支持在字段上进行计算，同样也支持在脚本（painless script）产生的结果之上进行计算，类比SQL中的max、min等函数。
   单值分析：只输出一个分析结果
   aggs_type 含义     min 最小值   max 最大值   avg 平均值   sum 求和   cardinality 去重求数量，相当于distinct count      多值分析">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="聚合" />
<meta property="og:description" content="聚合语法 #  { &#34;size&#34;: 0, &#34;aggs&#34;: { // 与query同级的关键词  &#34;&lt;aggs_name&gt;&#34;: { // 自定义的聚合名字  &#34;&lt;aggs_type&gt;&#34;: { // 聚合的定义：不同的Type &#43; Body  &lt;aggs_body&gt; }, &#34;aggs&#34;: {} // 子聚合查询  }, &#34;&lt;aggs_name_2&gt;&#34; : {} // 可以包含多个同级的聚合查询  } } Metric #   一些系列的统计方法，会基于数据集计算结果，除了支持在字段上进行计算，同样也支持在脚本（painless script）产生的结果之上进行计算，类比SQL中的max、min等函数。
   单值分析：只输出一个分析结果
   aggs_type 含义     min 最小值   max 最大值   avg 平均值   sum 求和   cardinality 去重求数量，相当于distinct count      多值分析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wxyyrain.github.io/docs/elasticsearch/mds/4_aggs/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2021-12-26T14:53:26+08:00" />
<meta property="article:modified_time" content="2021-12-26T14:53:26+08:00" />

<title>聚合 | My New Hugo Site</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css" integrity="sha256-RhgbyTN1upMgJudTs3xA5v&#43;LsWqe93DHi8xmPkV3sbo=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.3ea7de5fc85a8373b5d5df21ddd149cd2d7e779e3f55c62fdc7e8427de5830c7.js" integrity="sha256-PqfeX8hag3O11d8h3dFJzS1&#43;d54/VcYv3H6EJ95YMMc=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>My New Hugo Site</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/distribute/" class="">分布式数据系统</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/distribute/mds/data_copy/" class="">数据复制</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/distribute/mds/data_shard/" class="">数据分区</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/distribute/mds/challenge/" class="">分布式系统的挑战</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/distribute/mds/transaction/" class="">事务</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/distribute/mds/consistency/" class="">一致性与共识</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>数据结构和算法</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/algorithm/mds/base_data_structure/" class="">基础数据结构</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/elasticsearch/" class="">Elasticsearch</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/elasticsearch/mds/0_pre/" class="">前置知识</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/elasticsearch/mds/1_basic/" class="">基本使用</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/elasticsearch/mds/2_distribute/" class="">分布式原理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/elasticsearch/mds/3_search/" class="">搜索</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/elasticsearch/mds/4_aggs/" class=" active">聚合</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/elasticsearch/mds/5_model_design/" class="">数据建模</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/elasticsearch/mds/6_scale_out/" class="">水平扩展集群</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/elasticsearch/mds/7_cluster_setting/" class="">集群运维</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/elasticsearch/mds/8_index_lifecycle/" class="">索引生命周期管理</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/mysql/" class="">MySQL</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/mysql/mds/1_index/" class="">索引</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/mysql/mds/lock/" class="">锁</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/mysql/mds/transaction/" class="">事务</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://wxyyrain.github.io/docs/mysql/mds/log/" class="">日志</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>K8s</span>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Redis</span>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>微服务</span>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>聚合</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#聚合语法">聚合语法</a></li>
    <li><a href="#metric">Metric</a></li>
    <li><a href="#bucket">Bucket</a></li>
    <li><a href="#pipeline">Pipeline</a></li>
    <li><a href="#作用范围">作用范围</a></li>
    <li><a href="#聚合原理">聚合原理</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h2 id="聚合语法">
  聚合语法
  <a class="anchor" href="#%e8%81%9a%e5%90%88%e8%af%ad%e6%b3%95">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">0</span>,
  <span style="color:#f92672">&#34;aggs&#34;</span>: { <span style="color:#75715e">// 与query同级的关键词
</span><span style="color:#75715e"></span>    <span style="color:#f92672">&#34;&lt;aggs_name&gt;&#34;</span>: { <span style="color:#75715e">// 自定义的聚合名字
</span><span style="color:#75715e"></span>      <span style="color:#f92672">&#34;&lt;aggs_type&gt;&#34;</span>: { <span style="color:#75715e">// 聚合的定义：不同的Type + Body
</span><span style="color:#75715e"></span>        <span style="color:#960050;background-color:#1e0010">&lt;aggs_body&gt;</span>
      },
      <span style="color:#f92672">&#34;aggs&#34;</span>: {} <span style="color:#75715e">// 子聚合查询
</span><span style="color:#75715e"></span>    },
    <span style="color:#f92672">&#34;&lt;aggs_name_2&gt;&#34;</span> : {} <span style="color:#75715e">// 可以包含多个同级的聚合查询
</span><span style="color:#75715e"></span>  }
}
</code></pre></div><h2 id="metric">
  Metric
  <a class="anchor" href="#metric">#</a>
</h2>
<blockquote>
<p>一些系列的统计方法，会基于数据集计算结果，除了支持在字段上进行计算，同样也支持在脚本（painless script）产生的结果之上进行计算，类比SQL中的max、min等函数。</p>
</blockquote>
<ul>
<li>
<p>单值分析：只输出一个分析结果</p>
<table>
<thead>
<tr>
<th style="text-align:left">aggs_type</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">min</td>
<td>最小值</td>
</tr>
<tr>
<td style="text-align:left">max</td>
<td>最大值</td>
</tr>
<tr>
<td style="text-align:left">avg</td>
<td>平均值</td>
</tr>
<tr>
<td style="text-align:left">sum</td>
<td>求和</td>
</tr>
<tr>
<td style="text-align:left">cardinality</td>
<td>去重求数量，相当于distinct count</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>多值分析</p>
<table>
<thead>
<tr>
<th>aggs_type</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>stats</td>
<td>输出最低、最高、平均、求和、count的值</td>
</tr>
<tr>
<td>extended stats</td>
<td>多了平方和、标准差等统计值</td>
</tr>
<tr>
<td>percentile</td>
<td>百分位数</td>
</tr>
<tr>
<td>percentile rank</td>
<td>百分位排比</td>
</tr>
<tr>
<td>top hits</td>
<td>前几条数据</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h2 id="bucket">
  Bucket
  <a class="anchor" href="#bucket">#</a>
</h2>
<blockquote>
<p>一组满足条件的文档，类比SQL中的Group By。</p>
</blockquote>
<ul>
<li>
<p>Terms</p>
<blockquote>
<p>支持嵌套，嵌套后可输出 sum() group by类型聚合结果。</p>
</blockquote>
<p>注意：keyword 类型字段默认支持doc_values；text 类型字段需要在Mappings 中开启如下配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#e6db74">&#34;fielddata&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#66d9ef">true</span>
</code></pre></div><p>才能进行Terms Aggregation，会按照分词后的结果进行分桶。</p>
<ul>
<li>
<p>优化Terms 性能</p>
<p>在keyword字段上，打开eager_global_ordinals参数打开，每当有新的数据写入，term会加载到cache中。</p>
<p>适用场景：1. 聚合分析经常发生；2.索引不断有文档写入。</p>
</li>
<li>
<p>排序</p>
<p>指定 order，按照count 和 key进行排序。默认情况，按照count降序排列；指定size，就能返回相应的桶。</p>
</li>
</ul>
</li>
<li>
<p>数字类型</p>
<table>
<thead>
<tr>
<th>aggs_type</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>range</td>
<td>自定义数据范围作为桶，可以自定义key</td>
</tr>
<tr>
<td>Date range</td>
<td>日期范围</td>
</tr>
<tr>
<td>histogram</td>
<td>直方图</td>
</tr>
<tr>
<td>Date histogram</td>
<td>日期直方图</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h2 id="pipeline">
  Pipeline
  <a class="anchor" href="#pipeline">#</a>
</h2>
<blockquote>
<p>对其他的聚合结果进行二次聚合，通过bucket_path 关键字指定路径。Pipeline 的分析结果会输出到原结果中，根据位置的不同，分为Sibling和Parent两类。</p>
</blockquote>
<ul>
<li>
<p>Sibling - 结果和现有分析结果同级</p>
<table>
<thead>
<tr>
<th>type</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>min_bucket</td>
<td>最小的桶的值</td>
</tr>
<tr>
<td>max_bucket</td>
<td>最大的桶的值</td>
</tr>
<tr>
<td>avg_bucket</td>
<td>桶的值的平均数</td>
</tr>
<tr>
<td>stats_bucket</td>
<td>桶的值的统计值</td>
</tr>
<tr>
<td>percentiles_bucket</td>
<td>桶的值的百分位数</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Parent - 结果内嵌到现有的聚合分析结果中</p>
<table>
<thead>
<tr>
<th>type</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>dervative</td>
<td>求导</td>
</tr>
<tr>
<td>cumultive sum</td>
<td>累计求和</td>
</tr>
<tr>
<td>moving window</td>
<td>滑动窗口</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h2 id="作用范围">
  作用范围
  <a class="anchor" href="#%e4%bd%9c%e7%94%a8%e8%8c%83%e5%9b%b4">#</a>
</h2>
<blockquote>
<p>默认作用范围是 query 的查询结果集，同时支持以下方式改变作用范围：</p>
</blockquote>
<ul>
<li>
<p>Filter</p>
<blockquote>
<p>只过滤聚合的结果集，不过滤query 的结果集。</p>
</blockquote>
</li>
<li>
<p>Post Filter</p>
<blockquote>
<p>只过滤 query 的结果集，不过滤聚合的结果集。</p>
</blockquote>
<ul>
<li>性能考量：post_filter会在查询之后才会被执行，因此会失去过滤在性能上帮助(比如缓存)。因此post_filter应该只和聚合一起使用，并且仅当你使用了不同的过滤条件时。</li>
</ul>
</li>
<li>
<p>Global</p>
<blockquote>
<p>全局聚合，不受 query 作用域的影响。</p>
</blockquote>
</li>
</ul>
<h2 id="聚合原理">
  聚合原理
  <a class="anchor" href="#%e8%81%9a%e5%90%88%e5%8e%9f%e7%90%86">#</a>
</h2>
<ul>
<li>
<p>Min聚合分析执行流程</p>
<p><img src="/images/es_pic/min.png" alt="" /></p>
</li>
<li>
<p>Terms聚合分析的执行流程</p>
<ul>
<li>
<p>Terms Aggregation的特殊返回值</p>
<blockquote>
<p>doc_count_error_upper_bound：被遗漏的term分桶，包含的文档，可能有最大值；</p>
</blockquote>
<blockquote>
<p>sum_other_doc_count：除了返回结果 bucket 的terms 以外，其他terms 的文档总数（总数 - 返回的总数）。</p>
</blockquote>
</li>
<li>
<p>当 Terms的 size为3</p>
<p><img src="/images/es_pic/terms.png" alt="terms" /></p>
</li>
<li>
<p>Terms 不正确demo</p>
<p><img src="/images/es_pic/terms_error_demo.png" alt="terms" /></p>
<blockquote>
<p>Top3应该是A(12)、B(6)、D(6)。</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>解决Terms 不准的问题</p>
<ul>
<li>
<p>不准的原因</p>
<p>数据分散在多个分片上，Coordinating Node 无法获取数据全貌。</p>
</li>
<li>
<p>解决方案</p>
<ol>
<li>
<p>当数据量不大时，设置Primary Shard 为1，实现准确性；</p>
</li>
<li>
<p>在分布式数据上，设置shard_size参数，提高精确度。</p>
<blockquote>
<p>原理：每次从Shard上额外多获取数据，提升准确率。</p>
</blockquote>
</li>
</ol>
</li>
<li>
<p>shard_size 设定</p>
<ol>
<li>调整shard_size 大小，降低doc_count_error_upper_bound来提升准确度（增加整体计算量，提高了准确度，但会降低相应时间）；</li>
<li>shard Size 默认大小：shard size = size * 1.5 + 10</li>
</ol>
</li>
</ul>
</li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#聚合语法">聚合语法</a></li>
    <li><a href="#metric">Metric</a></li>
    <li><a href="#bucket">Bucket</a></li>
    <li><a href="#pipeline">Pipeline</a></li>
    <li><a href="#作用范围">作用范围</a></li>
    <li><a href="#聚合原理">聚合原理</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












